# Биолекторий МГУ - Веб-сайт

## Содержание
1. [Описание проекта](#описание-проекта)
2. [Технологии](#технологии)
3. [Структура проекта](#структура-проекта)
4. [Установка и запуск](#установка-и-запуск)
   - [Настройка окружения](#настройка-окружения)
   - [Локальная разработка](#локальная-разработка)
   - [Запуск с использованием Docker (Production)](#запуск-с-использованием-docker-production)
   - [Запуск тестов](#запуск-тестов)
   - [Устранение проблем с базой данных](#устранение-проблем-с-базой-данных)
5. [Административная панель](#административная-панель)
   - [Создание администратора](#создание-администратора)
   - [Добавление пункта меню для админ-панели](#добавление-пункта-меню-для-админ-панели)
   - [Доступ к административной панели](#доступ-к-административной-панели)
   - [Интерфейс административной панели](#интерфейс-административной-панели)
   - [Возможности административной панели](#возможности-административной-панели)
   - [Решение проблем](#решение-проблем)
6. [Организация загрузок файлов](#организация-загрузок-файлов)
   - [Структура загрузок](#структура-загрузок)
   - [Миграция существующих файлов](#миграция-существующих-файлов)
   - [Обновление шаблонов](#обновление-шаблонов)
   - [Обновление кода загрузки файлов](#обновление-кода-загрузки-файлов)
   - [Создание папок при запуске приложения](#создание-папок-при-запуске-приложения)
   - [Конфигурация](#конфигурация)
7. [Конфигурация приложения](#конфигурация-приложения)
   - [Основные настройки](#основные-настройки)
   - [Настройки окружения](#настройки-окружения)
   - [Настройки электронной почты](#настройки-электронной-почты)
8. [Возможные улучшения](#возможные-улучшения)
9. [Лицензия](#лицензия)

## Описание проекта

Биолекторий МГУ - это веб-приложение, разработанное для организации и проведения биологических лекций Московского Государственного Университета. Проект представляет собой полнофункциональный веб-сайт, который позволяет:

- Просматривать различные типы лекций (интерактивные, обычные и т.д.)
- Просматривать разделы лекций по тематикам
- Заказывать лекции через форму заказа
- Просматривать контактную информацию
- Управлять контентом через административную панель

Сайт включает в себя:
- Систему аутентификации и авторизации с ролями пользователей (admin, editor, user)
- Административную панель для управления контентом
- Систему загрузки и управления файлами
- Адаптивный дизайн для различных устройств
- Систему отправки электронных писем для подтверждения заказов и сброса паролей

## Технологии

Проект разработан с использованием следующих технологий:

- **Backend**: Flask (Python)
- **Database**: PostgreSQL
- **ORM**: SQLAlchemy
- **Migrations**: Flask-Migrate (Alembic)
- **Admin Panel**: Flask-Admin
- **Authentication**: Session-based auth with role-based access control
- **Forms**: Flask-WTF
- **Email**: Flask-Mail
- **Frontend**: HTML, CSS, JavaScript, Bootstrap 5
- **Containerization**: Docker, Docker Compose

## Структура проекта

```
biolectures/
├── admin/                  # Административная панель
│   ├── __init__.py
│   └── views.py            # Представления для админ-панели
├── auth/                   # Аутентификация и авторизация
│   ├── __init__.py
│   └── views.py            # Представления для аутентификации
├── models/                 # Модели данных
│   ├── __init__.py
│   └── models.py           # Определения моделей
├── static/                 # Статические файлы
│   ├── css/                # CSS стили
│   ├── js/                 # JavaScript файлы
│   ├── img/                # Изображения
│   └── uploads/            # Загруженные файлы
│       ├── avatars/        # Аватары пользователей
│       ├── blocks/         # Изображения для блоков
│       ├── lectures/       # Изображения для лекций
│       ├── sections/       # Изображения для разделов
│       └── contacts/       # Изображения для контактов
├── templates/              # HTML шаблоны
│   ├── admin/              # Шаблоны для админ-панели
│   ├── auth/               # Шаблоны для аутентификации
│   ├── email/              # Шаблоны для электронных писем
│   ├── block_templates/    # Шаблоны для блоков контента
│   ├── includes/           # Включаемые шаблоны
│   ├── base.html           # Базовый шаблон
│   ├── index.html          # Главная страница
│   ├── sections.html       # Страница разделов
│   ├── section_detail.html # Детальная страница раздела
│   ├── lecture_detail.html # Детальная страница лекции
│   ├── contacts.html       # Страница контактов
│   ├── order_form.html     # Форма заказа лекции
│   ├── profile.html        # Профиль пользователя
│   ├── 404.html            # Страница 404 ошибки
│   └── 500.html            # Страница 500 ошибки
├── views/                  # Представления (маршруты)
│   ├── __init__.py
│   └── main.py             # Пользовательские маршруты
├── migrations/             # Миграции базы данных
│   ├── versions/           # Версии миграций
│   ├── alembic.ini         # Конфигурация Alembic
│   ├── env.py              # Окружение для миграций
│   ├── README              # Информация о миграциях
│   └── script.py.mako      # Шаблон для скриптов миграций
├── app.py                  # Основной файл приложения
├── config.py               # Конфигурация приложения
├── utils.py                # Вспомогательные функции
├── wsgi.py                 # WSGI точка входа
├── .env                    # Переменные окружения
├── Dockerfile              # Dockerfile для сборки образа
├── docker-compose.yml      # Docker Compose конфигурация
└── requirements.txt        # Зависимости Python
```

## Установка и запуск

### Настройка окружения

Приложение поддерживает три режима работы:
- **development**: Режим разработки с включенной отладкой и выводом SQL-запросов
- **testing**: Режим тестирования с использованием in-memory SQLite
- **production**: Производственный режим без отладки

Режим работы определяется переменной окружения `FLASK_ENV`. По умолчанию используется режим `production`.

### Локальная разработка

1. Клонировать репозиторий:
   ```
   git clone https://github.com/gdenis82/Biolectures-Flask-Postgres.git
   cd biolectures
   ```

2. Создать и активировать виртуальное окружение:
   ```
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   source .venv/bin/activate  # Linux/Mac
   ```

3. Установить зависимости:
   ```
   pip install -r requirements.txt
   ```

4. Создать файл .env с переменными окружения:
   ```
   FLASK_APP=app.py
   FLASK_ENV=development  # Можно изменить на testing или production
   FLASK_DEBUG=1
   SECRET_KEY=your-secret-key
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/biolectures?client_encoding=utf8
   MAIL_SERVER=smtp.mail.ru
   MAIL_PORT=465
   MAIL_USE_SSL=True
   MAIL_USERNAME=your-email@mail.ru
   MAIL_PASSWORD=your-password
   MAIL_DEFAULT_SENDER=your-email@mail.ru
   BASE_URL=http://localhost:5000
   ```

5. Инициализировать базу данных:
   ```
   flask db init
   flask db migrate -m "Initial migration"
   flask db upgrade
   ```

6. Добавить элементы меню для аутентификации:
   ```
   python add_auth_menu_items.py
   ```

7. Запустить приложение:
   ```
   flask run
   ```

### Запуск с использованием Docker (Production)

1. Клонировать репозиторий:
   ```
   git clone https://github.com/yourusername/biolectures.git
   cd biolectures
   ```

2. Настроить переменные окружения в docker-compose.yml или создать файл .env:
   ```yaml
   environment:
     - FLASK_APP=app.py
     - FLASK_ENV=production
     - DATABASE_URL=postgresql://postgres:postgres@db:5432/biolectures?client_encoding=utf8
     - SECRET_KEY=your-secret-key
     - MAIL_SERVER=smtp.mail.ru
     - MAIL_PORT=465
     - MAIL_USE_SSL=True
     - MAIL_USERNAME=your-email@mail.ru
     - MAIL_PASSWORD=your-password
     - MAIL_DEFAULT_SENDER=your-email@mail.ru
     - BASE_URL=http://your-domain.com
   ```

3. Запустить с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

4. Приложение будет доступно по адресу http://localhost:5000 (или по настроенному домену)

### Запуск тестов

Для запуска в режиме тестирования:

1. Установить переменную окружения:
   ```
   export FLASK_ENV=testing  # Linux/Mac
   set FLASK_ENV=testing     # Windows
   ```

2. Запустить тесты:
   ```
   pytest
   ```

### Устранение проблем с базой данных

Если возникают проблемы с подключением к базе данных:

1. Убедитесь, что PostgreSQL запущен и доступен
2. Проверьте правильность строки подключения в .env или docker-compose.yml
3. Убедитесь, что параметр client_encoding=utf8 добавлен к строке подключения
4. Для сброса базы данных и начала с чистого листа:
   ```
   flask db stamp head  # Сбросить миграции до последней версии
   flask db migrate     # Создать новую миграцию
   flask db upgrade     # Применить миграцию
   python add_auth_menu_items.py  # Добавить элементы меню для аутентификации
   ```

## Административная панель

### Создание администратора

Для создания пользователя с правами администратора выполните следующие шаги:

1. Убедитесь, что приложение запущено хотя бы один раз для инициализации базы данных и ролей.
2. Запустите скрипт создания администратора:

```bash
python create_admin_user.py
```

3. Следуйте инструкциям в консоли:
   - Введите имя пользователя
   - Введите email
   - Введите пароль
   - Подтвердите пароль

После успешного создания пользователя вы увидите сообщение о том, что администратор создан.

### Добавление пункта меню для админ-панели

Чтобы добавить пункт меню для быстрого доступа к админ-панели, выполните:

```bash
python add_admin_menu_item.py
```

Этот скрипт добавит пункт "Админ панель" в главное меню сайта. Этот пункт будет виден только пользователям с ролью администратора.

### Доступ к административной панели

1. Войдите в систему, используя учетные данные администратора, по адресу `/auth/login`
2. После входа в систему вы можете получить доступ к админ-панели одним из способов:
   - Перейдите по прямому URL: `/admin`
   - Используйте пункт меню "Админ панель", если он был добавлен

### Интерфейс административной панели

После входа в административную панель вы увидите главную страницу панели управления, которая содержит следующие разделы:

1. **Пользователи и роли** - управление пользователями и их ролями в системе
2. **Лекции и разделы** - управление разделами лекций, лекциями и типами лекций
3. **Контакты и заказы** - управление контактной информацией и заказами на лекции
4. **Содержимое сайта** - управление пунктами меню и блоками на главной странице

Каждый раздел содержит ссылки на соответствующие страницы управления.

### Возможности административной панели

В административной панели вы можете:

- **Управлять пользователями и ролями**
  - Создавать, редактировать и удалять пользователей
  - Назначать пользователям различные роли
  - Управлять ролями в системе

- **Создавать и редактировать разделы лекций**
  - Добавлять новые разделы
  - Редактировать существующие разделы
  - Изменять порядок отображения разделов
  - Активировать/деактивировать разделы

- **Добавлять и редактировать лекции**
  - Создавать новые лекции
  - Редактировать содержимое лекций
  - Привязывать лекции к разделам
  - Устанавливать типы лекций
  - Активировать/деактивировать лекции

- **Управлять типами лекций**
  - Создавать новые типы лекций
  - Редактировать существующие типы

- **Редактировать контактную информацию**
  - Добавлять и редактировать контактные данные
  - Управлять отображением контактов на сайте

- **Управлять заказами на лекции**
  - Просматривать поступившие заказы
  - Изменять статус заказов
  - Обрабатывать заявки пользователей

- **Настраивать пункты меню**
  - Добавлять новые пункты меню
  - Редактировать существующие пункты
  - Изменять порядок отображения пунктов меню
  - Создавать иерархическую структуру меню

- **Редактировать блоки на главной странице**
  - Добавлять новые блоки контента
  - Редактировать существующие блоки
  - Изменять порядок отображения блоков
  - Активировать/деактивировать блоки

### Решение проблем

Если у вас возникли проблемы с доступом к админ-панели:

1. Убедитесь, что вы вошли в систему как пользователь с ролью администратора
2. Проверьте, что роль "admin" существует в базе данных
3. Убедитесь, что ваш пользователь имеет роль "admin"
4. Проверьте, что админ-панель правильно инициализирована в приложении

## Организация загрузок файлов

### Структура загрузок

В проекте реализована структурированная система для загружаемых файлов. Файлы разделены по категориям и хранятся в отдельных папках:

- `static/uploads/avatars` - аватары пользователей
- `static/uploads/blocks` - изображения для блоков на главной странице
- `static/uploads/lectures` - изображения для лекций
- `static/uploads/sections` - изображения для разделов
- `static/uploads/contacts` - изображения для контактов

### Миграция существующих файлов

Для перемещения существующих файлов в новую структуру папок был создан скрипт `move_files.py`. Запустите его следующим образом:

```
python move_files.py
```

Скрипт скопирует все существующие файлы в соответствующие папки на основе их типа.

### Обновление шаблонов

Следующие шаблоны были обновлены для использования новой структуры папок:

- `templates/profile.html` - обновлены ссылки на аватары пользователей
- `templates/index.html` - обновлены ссылки на изображения блоков и лекций
- `templates/section_detail.html` - обновлены ссылки на изображения разделов и лекций
- `templates/lecture_detail.html` - обновлены ссылки на изображения лекций

При разработке новых шаблонов или обновлении существующих, используйте следующий формат для ссылок на изображения:

```
url_for('static', filename='uploads/[тип_контента]/' + [имя_файла])
```

Где `[тип_контента]` - это одна из категорий (avatars, blocks, lectures, sections, contacts), а `[имя_файла]` - имя файла изображения.

### Обновление кода загрузки файлов

Код загрузки файлов в админ-панели и пользовательском интерфейсе был обновлен для использования новой структуры папок:

- `admin/views.py` - обновлены пути для загрузки файлов в админ-панели
- `views/main.py` - обновлен путь для загрузки аватаров пользователей

При разработке новых функций загрузки файлов, используйте соответствующие константы из конфигурации:

```python
app.config['UPLOAD_FOLDER_AVATARS']  # Для аватаров
app.config['UPLOAD_FOLDER_BLOCKS']   # Для блоков
app.config['UPLOAD_FOLDER_LECTURES'] # Для лекций
app.config['UPLOAD_FOLDER_SECTIONS'] # Для разделов
app.config['UPLOAD_FOLDER_CONTACTS'] # Для контактов
```

### Создание папок при запуске приложения

В файле `app.py` добавлен код для создания всех необходимых папок при запуске приложения:

```python
# Ensure the upload folders exist
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
os.makedirs(app.config['UPLOAD_FOLDER_AVATARS'], exist_ok=True)
os.makedirs(app.config['UPLOAD_FOLDER_BLOCKS'], exist_ok=True)
os.makedirs(app.config['UPLOAD_FOLDER_LECTURES'], exist_ok=True)
os.makedirs(app.config['UPLOAD_FOLDER_SECTIONS'], exist_ok=True)
os.makedirs(app.config['UPLOAD_FOLDER_CONTACTS'], exist_ok=True)
```

Это гарантирует, что все необходимые директории будут созданы при запуске приложения, даже если они отсутствуют в репозитории.

### Конфигурация

В файле `config.py` определены параметры конфигурации для путей к папкам загрузок:

```python
UPLOAD_FOLDER = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads')
UPLOAD_FOLDER_AVATARS = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads', 'avatars')
UPLOAD_FOLDER_BLOCKS = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads', 'blocks')
UPLOAD_FOLDER_LECTURES = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads', 'lectures')
UPLOAD_FOLDER_SECTIONS = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads', 'sections')
UPLOAD_FOLDER_CONTACTS = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'static', 'uploads', 'contacts')
```

Эти параметры используются в коде приложения для определения путей к папкам загрузок.

## Конфигурация приложения

### Основные настройки

Основные настройки приложения определены в файле `config.py`. Базовый класс `Config` содержит настройки, общие для всех окружений:

```python
class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY', 'default-secret-key')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB max upload size
    SITE_NAME = 'Биолекторий МГУ'
    BASE_URL = os.environ.get('BASE_URL', 'http://localhost:5000')
    # ... другие настройки
```

### Настройки окружения

Приложение поддерживает различные окружения, каждое со своими настройками:

```python
class DevelopmentConfig(Config):
    DEBUG = True
    SQLALCHEMY_ECHO = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

class ProductionConfig(Config):
    DEBUG = False
    TESTING = False
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
```

Выбор конфигурации осуществляется на основе переменной окружения `FLASK_ENV`:

```python
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
}
```

### Настройки электронной почты

Для отправки электронных писем (подтверждение регистрации, сброс пароля, уведомления о заказах) используются следующие настройки:

```python
MAIL_SERVER = os.environ.get('MAIL_SERVER', 'smtp.mail.ru')
MAIL_PORT = int(os.environ.get('MAIL_PORT', 465))
MAIL_USE_TLS = False
MAIL_USE_SSL = True
MAIL_USERNAME = os.environ.get('MAIL_USERNAME', 'your-email@mail.ru')
MAIL_PASSWORD = os.environ.get('MAIL_PASSWORD', 'your-password')
MAIL_DEFAULT_SENDER = os.environ.get('MAIL_DEFAULT_SENDER', 'your-email@mail.ru')
```

Эти настройки должны быть определены в файле `.env` или переданы как переменные окружения.

## Возможные улучшения

Для дальнейшего развития проекта рекомендуются следующие улучшения:

1. **Улучшение безопасности**:
   - Внедрение CSRF-защиты для всех форм
   - Реализация двухфакторной аутентификации
   - Улучшение валидации входных данных
   - Регулярное обновление зависимостей для устранения уязвимостей

2. **Оптимизация производительности**:
   - Кэширование часто используемых данных
   - Оптимизация SQL-запросов
   - Использование CDN для статических файлов
   - Внедрение асинхронной обработки для длительных операций

3. **Улучшение пользовательского интерфейса**:
   - Разработка полностью адаптивного дизайна
   - Улучшение доступности (accessibility)
   - Внедрение современных JavaScript-фреймворков для интерактивности
   - Оптимизация для мобильных устройств

4. **Расширение функциональности**:
   - Интеграция с системами онлайн-платежей для оплаты лекций
   - Добавление системы комментариев и отзывов
   - Реализация функционала для проведения онлайн-лекций
   - Интеграция с календарями для планирования лекций

5. **Улучшение процесса разработки**:
   - Внедрение CI/CD для автоматизации тестирования и деплоя
   - Расширение тестового покрытия
   - Улучшение документации кода
   - Внедрение статического анализа кода

6. **Мониторинг и аналитика**:
   - Интеграция с системами мониторинга (Sentry, Prometheus)
   - Добавление аналитики пользовательского поведения
   - Реализация логирования важных событий
   - Создание дашбордов для отслеживания ключевых метрик

7. **Локализация и интернационализация**:
   - Добавление поддержки нескольких языков
   - Адаптация контента для различных регионов
   - Поддержка различных форматов дат и чисел

8. **Улучшение SEO**:
   - Оптимизация метатегов
   - Создание карты сайта (sitemap.xml)
   - Улучшение структуры URL
   - Оптимизация скорости загрузки страниц

## Лицензия

Этот проект распространяется под лицензией MIT.

---

© 2024 Биолекторий МГУ. Все права защищены.
